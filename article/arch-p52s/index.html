<!DOCTYPE html><html><head><title>Arch Linux on a Lenovo Thinkpad P52s</title><meta charset="UTF-8"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="author" content="Steven Baldasty"><link rel="icon" type="image/x-icon" href="/logo.png"><link rel="stylesheet" href="/site.css"></head><body><div class="brand"><img src="/logo.png" title="Website logo" alt="Three stacked blue boxes with binary digits on them" width="86" height="86"><div><div class="title">Bit flipping laboratory &amp; Personal website</div><div class="caption">No sneaky cookies haunt these pages, but whether someone tracks you I do not know. Information flows through many channels, and every action leaves a trace.</div></div></div><div class="nav"><a href="/">Home</a><a href="/article/">Articles</a><a href="/media/">Media</a></div><hr><div class="article"><div class="date"> 2024-07-10 </div><div class="summary"> I installed Arch Linux on a Lenovo Thinkpad P52s using <code>btrfs</code> for the filesystem and <code>grub</code> for the bootloader. I recorded my process, beginning in a fresh installation image environment and ending with the root user booting into the new system. </div><h1> Arch Linux on a Lenovo Thinkpad P52s </h1><p> I drew from several sources. The sources all have slightly different goals and focus areas. Most offer a useful generality this document may lack. </p><h2> Partitions </h2><p> Hopefully already well understood, but always worth mentioning, these instructions delete all data on the disk. Device names may vary by system. </p><pre class="snippet">fdisk /dev/nvme0n1</pre><p> The <code>fdisk</code> utility launches. It presents an interactive prompt. </p><ul><li><p><b>Delete any existing partitions.</b> Enter <kbd>d</kbd> and accept the default partition repeatedly until no partitions remain.</p></li><li><p><b>Create EFI partition.</b> Enter <kbd>n</kbd> to create a new partition. Enter <kbd>1</kbd> for the <i>partition number</i>. Accept the default <i>first sector</i>. Enter <kbd>+4G</kbd> for the <i>size</i>. Then <code>fdisk</code> returns to its top-level prompt. Enter <kbd>t</kbd> to set the partition type. Enter <kbd>1</kbd> for the <i>partition number</i>. Enter <kbd>uefi</kbd> for the <i>partition type</i>.</p></li><li><p><b>Create root partition.</b> Enter <kbd>n</kbd> to create a new partition. Enter <kbd>2</kbd> for the <i>partition number</i>. Accept the default <i>first sector</i>. Accept the default <i>size</i> to use all remaining disk space.</p></li><li><p><b>Write changes.</b> Optionally enter <kbd>p</kbd> to display the changes. Enter <kbd>w</kbd> to write the changes to disk. Then <code>fdisk</code> exits automatically.</p></li></ul><p> Two new devices <code>/dev/nvme0np1</code> and <code>/dev/nvme0np1</code> exist now, and correspond to the two new partitions. </p><h2>Filesystems</h2><p> Format the root partition with a <code>btrfs</code> filesystem to support snapshots. Ultimately only the subvolumes of this partition will be mounted, but for now temporarily mount it for the purpose of creating the subvolumes. Good candidates are parts of the filesystem that contain large or rapidly changing data unimportant for system restoration purposes. Create the subvolumes. The subvolumes appear under the partition's mount point as directories. Unmount the partition. Mount each of the subvolumes in its proper place. The <code>noatime</code> option improves performance by not tracking access times on files. </p><pre class="snippet"># Format the root partition
mkfs.btrfs /dev/nvme0n1p2

# Mount the partition temporarily
mount /dev/nvme0n1p2 /mnt

# Create subvolumes in the partition
btrfs su cr /mnt/@
btrfs su cr /mnt/@home
btrfs su cr /mnt/@root_btrsnap
btrfs su cr /mnt/@tmp
btrfs su cr /mnt/@var_cache
btrfs su cr /mnt/@var_log
btrfs su cr /mnt/@var_tmp

# Umount the partition
umount /mnt

# Mount the subvolumes
mount --mkdir -o noatime,compress=lzo,space_cache=v2,subvol=/@ /dev/nvme0n1p2 /mnt
mount --mkdir -o noatime,compress=lzo,space_cache=v2,subvol=/@home /dev/nvme0n1p2 /mnt/home
mount --mkdir -o noatime,compress=lzo,space_cache=v2,subvol=/@root_btrsnap /dev/nvme0n1p2 /mnt/root/btrsnap
mount --mkdir -o noatime,compress=lzo,space_cache=v2,subvol=/@tmp /dev/nvme0n1p2 /mnt/tmp
mount --mkdir -o noatime,compress=lzo,space_cache=v2,subvol=/@var_cache /dev/nvme0n1p2 /mnt/var/cache
mount --mkdir -o noatime,compress=lzo,space_cache=v2,subvol=/@var_log /dev/nvme0n1p2 /mnt/var/log
mount --mkdir -o noatime,compress=lzo,space_cache=v2,subvol=/@var_tmp /dev/nvme0n1p2 /mnt/var/tmp</pre><p> Format the EFI parition with a FAT32 filesystem for compatibility with the firmware that will need to interact with it, and then mount the partition. The <code>fmask</code> and <code>dmask</code> options may help prevent certain nondescript boot issues I encountered. </p><pre class="snippet">mkfs.vfat -F32 /dev/nvme0n1p1
mount --mkdir -o fmask=0077,dmask=0077 /dev/nvme0n1p1 /mnt/efi</pre><h2> Installation </h2><p> Connect to the internet wirelessly, replacing <kbd>MyNetwork</kbd> and <kbd>MyPassphrase</kbd> appropriately. Install the minimum necessary packages. Generate the <code>fstab</code> file. This file remembers where we mounted everything. </p><pre class="snippet">iwctl --passphrase MyPassphrase station wlan0 connect MyNetwork
pacstrap -K /mnt base linux linux-firmware
genfstab -U /mnt &gt;&gt; /mnt/etc/fstab

# Optionally take a snapshot
btrfs su snapshot /mnt /mnt/root/btrsnap/0000.base</pre><h2> Configuration </h2><p> Enter into the new installation. Install <code>iwd</code> and <code>openresolv</code> for internet access without help from the installation image, the text editor <code>vim</code> for editing configuration files, and <code>btrfs-progs</code> for taking system snapshots. Go through a number of mundane steps per the installation guide. </p><pre class="snippet">arch-chroot /mnt
pacman -S iwd openresolv vim btrfs-progs

# Set root password
passwd

# Create /etc/localtime (replace MyRegion and MyCity appropriately)
ln -sf /usr/share/zoneinfo/MyRegion/MyCity /etc/localtime

# I didn&#39;t read up on what this does
hwclock --systohc

# Uncomment the appropriate UTF-8 line, generate locale(s)
vim /etc/locale.gen
locale-gen</pre><h2> Bootloader </h2><p> Install the necessary packages to make a <code>grub</code> bootloader. Then install the bootloader and set up its configuration. Consider saving the bootloader installation and configuration lines as a script for later use. </p><pre class="snippet">pacman -S grub efibootmgr
grub-install --target=x86_64-efi --efi-directory=/efi --bootloader-id=arch_grub
grub-mkconfig -o /boot/grub/grub.cfg

# Optionally take a snapshot
btrfs su snapshot / /root/snapshots/0001.configure</pre><h2> Reboot </h2><p> Exit out of the <code>chroot</code>, unmount all the filesystems, and restart the system. </p><pre class="snippet"># Back in the installation image environment
umount -R /mnt
reboot</pre><p> Remove the installation media and restart the laptop. If all goes well log in as <kbd>root</kbd>. </p><p> These instructions configure and enable two services. The <code>iwd</code> service provides wireless internet access. The <code>systemd-resolved</code> service provides domain name resolution. These instructions also cover network configuration steps leftover from the minimal Arch installation. </p><h2> Networking </h2><p> On a single line in <code>/etc/hostname</code> assign the machine a hostname. For example the entire contents of the file could be <kbd>MyHostname</kbd>. Local applications can use the hostname to reference the machine. </p><pre class="snippet">vim /etc/hostname</pre><h2> Name resolution service </h2><p> I tried extensively to get <code>systemd-resolved</code> working but could not get past an issue where many names resolved but some did not, including the name of this site for instance. I switched to <code>resolvconf</code>. </p><p> Per the Arch wiki, create the <code>resolv.conf</code> configuration file. </p><pre class="snippet">resolvconf -u</pre><h2> Wireless service </h2><p> There is no <code>iwd</code> configuration file by default. Paste in this minimal configuration file when the time comes. </p><div class="codesnippet"><div class="header">/etc/iwd/main.conf</div><pre class="lang-linuxconfig">[General]
EnableNetworkConfiguration=true

[Network]
NameResolvingService=resolvconf</pre></div><p>Start and enable the <code>iwd</code> service. Starting the service launches it immediately. Enabling the servicec causes it to start automatically on boot. Connect to the internet wirelessly, replacing <kbd>MyNetwork</kbd> and <kbd>MyPassphrase</kbd> appropriately.</p><div class="codesnippet"><pre class="lang-bash"># Create the iwd config file
vim /etc/iwd/main.conf

# Start and enable iwd
systemctl enable iwd
systemctl start iwd

# Connect to a wireless network
iwctl --passphrase MyPassphrase station wlan0 connect MyNetwork

# Optionally view the network file that was created
cat /var/lib/iwd/MyNetwork.psk</pre></div><p> Further wireless refinements are possible and likely desirable. The installation guides consulted contain additional network configuration recommendations I do not yet understand. Meanwhile these steps suffice to make the Arch installation usable. </p><p> Traditionally in Linux systems one creates a non-root user for regular operations. Even in cases where only one person uses the system, having a safeguard against accidentally running dangerous commands as root is nice. </p><h2> Adding the user </h2><p> Add a new user with a home directory and <code>bash</code> for a login shell. Set the new user's password. Optionally exit the root session and test logging in as the new user. </p><pre class="snippet">useradd -m -s /bin/bash MyUsername
passwd MyUsername

# Optionally see the new home directory
ls /home</pre><h2> Root access </h2><p> Install the <code>sudo</code> package. Edit the <code>sudo</code> configuration file with the special <code>visudo</code> utility per below. Sources recommend doing otherwise, but editing <code>/etc/sudoers</code> directly also seems to work. Add the new user to the <code>wheel</code> group. Optionally test running commands as root by prefixing them with <code>sudo</code> when logged in as the new user. </p><pre class="snippet"># Install sudo
pacman -S sudo

# Uncomment the line &#34;%wheel ALL=(ALL:ALL) ALL&#34;
EDITOR=vim visudo

usermod -a -G wheel MyUsername</pre><h2> Power privileges </h2><p> For convenience the non-root user should have the ability to shut down and reboot the system. Install the <code>polkit</code> package. </p><pre class="snippet">pacman -S polkit</pre><p> Surprisingly without enabling any service the non-root user now has the ability to use the <code>shutdown</code> and <code>reboot</code> commands. Perhaps they can now run other commands as well. There are certainly many things I still do not understand about <code>polkit</code>. </p><h2> Installing sway </h2><p> Chrome needs a graphical environment to run in, such as a wayland compositor like <code>sway</code>. Install <code>sway</code> and choose <code>gnu-free-fonts</code> when the installation process asks about a font. Other choices probably work fine. Also install <code>alacritty</code> which is a terminal for <code>sway</code>. Copy the default <code>sway</code> configuration file to the user home directory. Edit the configuration file to set <code>alacritty</code> as the default terminal. Launch sway. Open a terminal by pressing the <i>Win+Enter</i> keys together. Continue to the remaining steps in the <code>alacritty</code> terminal. </p><pre class="snippet"># Install sway and alacritty
sudo pacman -S sway alacritty

# Use the default sway configuration file
mkdir -p ~/.config/sway
cp /etc/sway/config ~/.config/sway

# Change &#34;set $term foot&#34; to &#34;set $term alacritty&#34;
vim ~/.config/sway/config

# Launch sway
sway</pre><h2> Installing git </h2><p> Chrome is not available through <code>pacman</code>, only through the AUR. A straightforward way to use AUR is with the <code>yay</code> package. The most straightforward way to install <code>yay</code> is cloning it using <code>git</code>. </p><p> Install <code>git</code>. Optionally set the name for default branches. This avoids warning messages when cloning repositories. The common choice used to be <i>master</i> but recently seems to have shifted to <i>main</i>. Optionally set a <i>name</i> and <i>email</i> which will attribute authorship to future commits. </p><pre class="snippet">sudo pacman -S git

git config --global init.defaultBranch main
git config --global user.name &#34;My Name&#34;
git config --global user.email &#34;myemail@bitflippin.com&#34;</pre><h2> Installing yay </h2><p> Clone the <code>yay</code> repository. Build and install <code>yay</code>. Once installed the repository is no longer necessary. Interestingly <code>yay</code> seems to install itelf as a <code>yay</code> package! </p><pre class="snippet">git clone https://aur.archlinux.org/yay.git
cd yay
sudo pacman -S base-devel
makepkg -si
cd ..
rm -rf yay</pre><h2> Google Chrome </h2><p> All that remains is to install Google Chrome and run it. On wayland the additional flag below may be necessary. It is for me. </p><pre class="snippet">yay -S google-chrome
google-chrome-stable --ozone-platform=wayland</pre><p> Small usability gaps like having <code>sway</code> start on login, having <code>google-chrome-stable</code> launch without a terminal, and further customizations of <code>sway</code> still remain; however these steps are sufficient to get started. </p></div><hr><div class="author"><div><div class="title">Steven Baldasty</div><div class="caption">Proud father, Barefoot runner, Chocolate enthusiast, Seasoned software engineer, Starry eyed PhD student, Novice human</div></div><img src="/selfie.png" title="Sketch courtesy of my daughter" alt="Handsome brown haired man with glasses" width="80" height="88"></div></body></html>